---
title: "Step1 Team Project Multivariate Analysis"
author: "Adrian White, Cesar Conejo, Xavier Bryant"
date: "12/6/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.width=10, fig.height=4.5)

# Libraries
library(ggplot2)
library(knitr)
library(corrplot)
library(rrcov)
library(factoextra)
library(plotrix)


# Dataset:
load('rda/clinical_trial_complete.rda')
source("scripts/functions/graph_functions.R")

# Deleting some categorical variables
X <- clinical_trial_complete[,-c(1,11,13,14,15,16,18)]

#X <- X[1:100,]

# Remove the file
rm(clinical_trial_complete)

# Remember: This add some log transformations:

color_1 <- "deepskyblue2"
color_2 <- "orange2"        # death
color_3 <- "seagreen2"      # survival
color_4 <- "darkorchid4"
```

## Introduction data set

We have selected the [CRASH-2](http://biostat.mc.vanderbilt.edu/wiki/pub/Main/DataSets/crash2.html) data set provided by Vanderbilt School of Biostatistics for our project. It describes the outcome of a randomized controlled trial and economic valuation of the effects of tranexamic acid on death, vascular occlusive events, and transfusion requirement in bleeding trauma patients. Tranexamic acid reduces bleeding in trauma patients undergoing surgery but is an expensive treatment option. The trial's objective was to assess the effects and cost-effectiveness of an early administration of this medication. 

Participants of the study were adults with, or at risk of, significant bleeding within 8 hours of injury. Sample randomization was determined by the allocation of an eight-digit sequence randomly generated by a computer. Patients and staff were masked to the treatment allocation of the tranexamic acid. The treatment variable is unfortunately unavailable in our data set since it is proprietary to those who performed the original research. Our data is therefore contains the observations of the control subset and the treatment. We have sent an email to request if sharing this variable is possible. If we receive the variable, we will include it in Step 2 of this assignment.

We have adjusted the original data set to remove some variables that were not relevant to our investigation. We have removed variables regarding the exact surgical procedures administered to patients, various IDs, and details on the patient outcome. We removed the health outcome columns because of complications regarding missing data, where the boolean structure of the columns relating to specific outcomes, like stroke or pulmonary embolism, left a large number of cases with missing values. Instead, we added a boolean variable for a general outcome of survival to assess the efficacy of the procedure, rather than looking at particular health outcomes in post-surgery for living patients.

We will be using variables regarding the sex, age, and injury of the patient as well as certain biometrics, like blood pressure, respiratory and heart rates, details on surgical blood transfusion, and a boolean variable on the survival of the patient. Our selection provides us with a balance of continuous and categorical variables, many of which are boolean, with minimal complications due to missing data. In summary, the data set consists of $n = 9497$ observations, with 11 columns, which $p = 8$ are quantitative and 3 are qualitative.

Moreover, the normal ranges of the biometric measurements are also added, in order to have a point of comparison with the observations present in the data set and in this way determine if they are abnormal with respect to the normal metrics.

\newpage

### Summary variables in the data set

The variables in this dataset are the following:

1. sex: (Boolean) The sex of the patient (Male/Female)

2. age : (Numerical) Age of the patient(Years)

3. injurytime: (Numerical) Hours since injury (Hours)

4. injurytype:	(Categorical) Type of injury {Blunt, Penetrating, Blunt and Penetrating}

5. sbp: (Numerical) Systolic Blood Pressure (mmHg). Normal range for adults at rest: less 120 mmHg.

6. rr: (Numerical) Respiratory Rate (breaths per minute). Normal range for adults at rest: 12 - 20 breaths per minute.

7. cc: (Numerical) Central Capillary Refill Time (seconds). Normal range for adults at rest. Less than 3 seconds.

8. hr: (Numerical) Heart Rate (beats per minute). Normal range for adults at rest: 60 - 100 bpm.

9. ndaysicu: (Numerical) Number of days in ICU (days)

10. ncell: (Numerical) Number of Units of Red Call Products Transfused.

11. Death: (Boolean) Indicator if the patient survived after the procedure


A summary of the data type is the following:

```{r echo=FALSE}
variable <- c("sex","age","injurytime","injurytype","sbp","rr","cc","hr","ndaysicu","ncell","death")

type_variable <- c("Qualitative","Quantitative","Quantitative","Qualitative","Quantitative","Quantitative","Quantitative","Quantitative","Quantitative","Quantitative","Qualitative")


sub_type_variable <- c("Nominal","Continuous","Continuous","Nominal","Continuous","Continuous","Continuous","Continuous","Discrete","Continuous","Nominal")

summary.methods <- data.frame(variable,
                              type_variable,
                              sub_type_variable,
                              row.names = NULL)
knitr::kable(summary.methods)
```

A review of the structure of the dataset is the following:



```{r echo=FALSE}
str(X[,-c(12:16)])
```

\newpage



A summary of the values in the data set are:


```{r echo=FALSE}
summary(X[,-c(12:16)])
```



Finally, the list of different values by column is the following:



```{r echo=FALSE}
table <- apply(X[,-c(12:16)], 2, function(x) length(unique(x)))
kable(t(table),
      caption="Count of distinct values of each variable", 
      align="c")
```

\newpage

## Visual Analysis

### Univariate Analysis

First, we will review the distribution of the variables involved in the data set.

In the case of *age*, the Figure \ref{fig:age} reflects how this variable appears to be largely weighted to the left, with lower ages featuring more frequently than those that are greater, possibly reflecting that younger people often take more risk and work higher at-risk occupations, raising their chance of experiencing trauma involving bleeding.



```{r age, fig.cap = "Distribution of age variable\\label{fig:age}", echo=FALSE}
plothist(col_name = "age", df = X, ylabtext = "All participants",  color_1, density_plot = FALSE)
```

The Figure \ref{fig:injurytime} below shows the distribution of the variable Injury  (*injurytime*) We can see how this variable is highly skewed to the left with almost all values falling below ten minutes since the injury was experienced. This is likely due to the fact, that in cases of serious injury, victims are brought to the hospital quite quickly as is the case for this data set on trauma. We apply a *log* transformation to this variable `log_injurytime = log(injurytime + 1)`, similarly to many other variables we have, because of the weight of the variables to the left of the distribution, in order to make a more normalized distribution. The *log* transformation as we can see in the below of Figure \ref{fig:injurytime}. After the *log* transformation, we can see that two observations remain quite separate , with a value of four, that appears as potential outlier to the distribution, as they have almost 4 times the median value. 



```{r injurytime, fig.cap = "Distribution of injurytime variable and log of injurytime\\label{fig:injurytime}", echo=FALSE}
plothistlog(col_name = "injurytime", colname_log = "log_injurytime" ,df = X, breaks_colname_log = 10, ylabtext = "All participants", color_1)
```



For *sbp* (Systolic Blood Pressure), the distribution is a fairly centrally balanced distribution around 90 mmHg. This is logical as a sample of biological characteristics observed in a population is likely to have most people around the mean and then a reasonably tight distribution of those who differ, similar to that of other biological features like height. Furthermore, most people are fairly young in the sample and therefore would have rates that deviant less from the norm, at a healthy level. The distribution is given by Figure \ref{fig:sbp}.



```{r sbp, fig.cap = "Distribution of sbp (Systolic Blood Pressure)\\label{fig:sbp}", echo=FALSE}
plothist(col_name = "sbp", df = X, ylabtext = "All participants",  color_1, density_plot = FALSE)
```

*rr* (Respiratory Rate) appears, similar to sbp, resembling a moderately balanced distribution around 22 respirations per minute, although *rr* is weighted more to the left. The distribution of this variable is showed in Figure \ref{fig:rr}. Taking a *log* transformation `log_rr = log(rr)`, we have the new distribution below as part of Figure \ref{fig:rr}. After the log transformation, the distribution remains quite spread out with a number fo values beyond the whiskers of the box plot. The *log* transformation in this case has not significantly changed the shape of the distribution, it does not shift much more towards a normal distribution after the *log* transformation.




```{r rr, fig.cap = "Distribution of rr (Respiratory Rate) and logrr\\label{fig:rr}", echo=FALSE}
plothistlog(col_name = "rr", colname_log = "log_rr" ,df = X, breaks_colname_log = 8, ylabtext = "All participants", color_1)
```

\newpage

In the case of *hr* (Heart rate), Figure \ref{fig:hr} has a distribution that seems fairly balanced at around 110, similar to the variables above, like *sbp* and *rr*. However, many values remain outside the whiskers and the IQR is quite tight, showing most people fall within a tight range but there is a number of people who have irregular rates on either side.

```{r hr, fig.cap = "Distribution of hh (hearth Rate)\\label{fig:hr}", echo=FALSE}
plothist(col_name = "hr", df = X, ylabtext = "All participants",  color_1, density_plot = FALSE)
```

For *cc* (Central capillary) refill has 75% of the observations below roughly 4 as we can appreciate in Figure \ref{fig:cc}. However, the distribution is right-skewed. As a result, we apply a *log* transformation `log_cc = log(cc)` that is given in the below part Figure \ref{fig:cc}. The log has made the distribution more normal, and was quite successful in this case. There remains a number of observations to the far right of the distribution, which could be possible outliers as the represent values approximately three times the median. 



```{r cc, fig.cap = "Distribution of cc (Central capillary) and log transformation\\label{fig:cc}", echo=FALSE}
plothistlog(col_name = "cc", colname_log = "log_cc" ,df = X, breaks_colname_log = 8, ylabtext = "All participants", color_1)
```

The Figure \ref{fig:ndaysicu} shows the distribution of the *ndaysicu:* variable. In this case, the distribution is heavily weighted to the left and right-skewed. Most patients it seems, with injuries at high risk of bleeding, do not often need to remain in the hospital for long. The transformed distribution `log_ndaysicu = log(ndaysicu + 1)` is given in the below part of figure \ref{fig:ndaysicu}. After the *log* transformation, this distribution doesn't appear much more gaussian in nature. The values are still heavily weighted the left. No values appear outside the whiskers, however, therefore this leads us to believe that there is not much likelihood of outliers in this distribution.



```{r ndaysicu, fig.cap = "Distribution of ndaysicu and log transformation\\label{fig:ndaysicu}", echo=FALSE}
plothistlog(col_name = "ndaysicu", colname_log = "log_ndaysicu" ,df = X, breaks_colname_log = 10, ylabtext = "All participants", color_1)

```

Finally, for the *ncell* distribution is weighted to the left with a median of 3 as we can appreciate in the figure \ref{fig:ncell}. The conclusion of this, is that many patients only need a small number of or zero units of red cell products transfused. Due to this variable being highly weighted to the right, we apply the *log* transformation  `log_ncell = log(ncell + 1)` of the figure \ref{fig:ncell} in their below part of the Figure. After transformation, the variables visually appears to be more Gaussian, but a large number of values remain outside the whiskers on the right of the distribution, though none appear distinct enough for the others to be outliers.




```{r ncell, fig.cap = "Distribution of ncell\\label{fig:ncell}", echo=FALSE}
plothistlog(col_name = "ncell", colname_log = "log_ncell" ,df = X, breaks_colname_log = 8, ylabtext = "All participants", color_1)
```

For the categorical variables, we will focus on the distributions of deaths, where 0 represents survival. The Figure \ref{fig:deaths}, shows that approximately for each death, 4 people survive. In the context of this problem, if we have an unbalanced proportion of people that survive, it can be considered as a sign that most people survive trauma injuries in the data set and that with the administration of the drug, most people survive . Although, this is not necessarily due to the administration of the drug as both the control and treatment are contained in this data set.


```{r deaths, fig.cap = "Distribution of deaths\\label{fig:deaths}", echo=FALSE}
ggplot(X) +
  geom_bar(aes( x = death, fill = death)) +
  labs(title = "Distribution of death") +
  scale_fill_manual(values=c(color_3, color_2))
```

\newpage

### Univariate Analysis by death - survival patients



On the other hand, we can study some relations of the quantitative variables in terms of the categorical variable death. 


Figure \ref{fig:agedeath}, shows us that those who survive (0) are on average younger than those who do not survive, which is logical, as younger people likely fair better in trauma accidents (at risk of significant bleeding, which this trail assesses). Aside from the median being slightly smaller than for those who survive, the distributions are fairly similar with a scew to the right. Participants in this trial are on average are quite young, roughly 3-, which could be due to sampling, but also because younger people are more likely to suffer from trauma accidents due to the jobs that they do and a increased propensity for risk taking behaviour. 



```{r agedeath, fig.cap = "Distribution of Age in terms of death\\label{fig:agedeath}", echo=FALSE}
plothist_factor("age", "death", X, "Death", color_2, color_3, density_plot = FALSE)
```



Figure \ref{fig:loginjurytimedeath} showing *log* injury time in comparison, those who do not survive have longer relative injury time on average, and the IQR is also wider as well as the whiskers. However, there are still values of those with longer injury times who did survive, however they appare less frequently.



```{r loginjurytimedeath, fig.cap = "Distribution of the log injurytime in terms of death\\label{fig:loginjurytimedeath}", echo=FALSE}
plothist_factor("log_injurytime", "death", X, "Death", color_2, color_3, density_plot = FALSE)
```



Figure \ref{fig:sbpdeath} showing sbp (Systolic Blood Pressure) against death, shows that those who survive (O), have distribution lightly to the left of that of the those who do not survive. This could be logical as those who survive have a higher blood pressure, initially, then those who eventually do not.



```{r sbpdeath, fig.cap = "Distribution of sbp (Systolic Blood Pressure) in terms of death\\label{fig:sbpdeath}", echo=FALSE}
plothist_factor("sbp", "death", X, "Death", color_2, color_3, density_plot = FALSE)
```

Figure \ref{fig:loginjurytimedeath} compares *log* Respiratory rate (rr) with those who do not survive (1) have a slightly higher mean those who survive (1). This seems to lead us to believe, that those who do not survive, in some cases more often have a higher than average respiratory rate. 




```{r logrrdeath, fig.cap = "Distribution of log transformation of rr (Respiratory Rate) in terms of death\\label{fig:logrrdeath}", echo=FALSE}
plothist_factor("log_rr", "death", X, "Death", color_2, color_3, density_plot = FALSE)
```

Figure \ref{fig:hrdeath}, similar to *log* Respiratory Rate, the distribution and median of *log* Heart rate for those who do not survive is slightly higher than who survive.



```{r hrdeath, fig.cap = "Distribution of hh (hearth Rate) in terms of death\\label{fig:hrdeath}", echo=FALSE}
plothist_factor("hr", "death", X, "Death", color_2, color_3, density_plot = FALSE)
```


Figure \ref{fig:logccdeath}, also resembling hr and rr, cc (Central Capillary Refill Time in seconds) has a distribution further to the right, although more extreme than hr and rr, which could show that cc increases like hr and rr on average for people who will not survive. We also remain to see a limited number of of observations to the the extreme right, which could be outliers. 




```{r logccdeath, fig.cap = "Distribution of log transformation of cc (Central capillary) in terms of death\\label{fig:logccdeath}", echo=FALSE}
plothist_factor("log_cc", "death", X, "Death", color_2, color_3, density_plot = FALSE)
```


\newpage

Figure \ref{fig:logndaysicudeath}, shows that days in the ICU (ndaysicu), has a very similar distribution with an identical median, likely due to the fact that most people who suffer from trauma injuries only spend a very limited relative amount of time in ICU. We see that, for those who survive (0), the 75% quartile is slightly larger, and when reviewing the histogram, more observations are on the further right end of the spectrum (more relative days in hospital). This possibly indicates to us that those who are more likely to survive are kept in the ICU for longer to heal some cases.




```{r logndaysicudeath, fig.cap = "Distribution of log ndaysicu in terms of death\\label{fig:logndaysicudeath}", echo=FALSE}
plothist_factor("log_ndaysicu", "death", X, "Death", color_2, color_3, density_plot = FALSE)
```




Figure \ref{fig:logncelldeath} shows the *log* value of  red blood cells transfused (ncell) accounting for death. Those who do not survive (1), have a broader distribution with the 75% quartile being larger, possibly indicating that for those who will not surive, more blood cells are transfused for more grave injuries in some cases.  



```{r logncelldeath, fig.cap = "Distribution of log ncell in terms of death\\label{fig:logncelldeath}", echo=FALSE}
plothist_factor("log_ncell", "death", X, "Death", color_2, color_3, density_plot = FALSE)
```

\newpage


Finally, the scatter plot in Figure 18 we cannot see any significant relationships but the variables, while accounting for Death. There does not seem be any visual relationship between any of the variables that are outstanding. 


![Scatter plot of all quantitiative variables](figure_output/pairs_death.png)

\newpage

The PCP plot in Figure 19, generally matches with our observations about the scatterplot, that comparing those who survive and do not, follow the same visual pattern. For *log_cc*, *hr*, and *log_ndaysicu*, those who survive appear to have values that are more broadly dispersed, but this could be due to the fact those who survive represent a majority of the sample size. Although, comparing with the histograms and box plots, *log_cc*, *hr*, and *log_ndaysicu* do appear to have more dispersed distributions and wider IQRs. 




![PCP plot of all quantitiative variables](figure_output/pcp_death.png)

\newpage

The Andrews' plot in Figure 20, matches our previous analysis in Figure 18 and 19, that variables share similar distributions and relationships when accounting for Death, as the Andrew Plot does not show any dramatic differences between the two groups.



![Andrews' plot of all quantitiative variables](figure_output/andrew_death.png)



In conclusion, we see that when accounting for difference categorical variables and Death, the distributions for our quantitative variables do not change significantly. We can see some minor changes in distributions and means.  COMPLETE LATER.



In the next section we will make some inference using sample estimators of mean, covariance, and correlation.



\newpage

## Sample Estimators

### Sample mean


Below is the sample mean vector for all the variables in our analysis, without controlling for death.


```{r, echo=FALSE}
X <- X[,-c(3,6,7,9,10)]
X_quan <- X[,-c(1,3,6)]

m <- colMeans(X_quan)

knitr::kable(t(m),
      row.names = FALSE,
      caption = "Sample mean",
      align="c")
```



This table shows the mean while setting death to 1, or for those who do not survive.



```{r, echo=FALSE}
X_death <- X_quan[X$death==1,]
m_death <- colMeans(X_death)

knitr::kable(t(m_death),
      row.names = FALSE,
      caption = "Sample mean: Do not survive",
      align="c")
```



Now provided is the Sample mean for the variables when the patient survives, or when death = 0.




```{r, echo=FALSE}
X_life <- X_quan[X$death==0,]
m_life <- colMeans(X_life)

knitr::kable(t(m_life),
      row.names = FALSE,
      caption = "Sample mean: Survive",
      align="c")
```



Although touched upon above, comparing the means when controlling for *death*, overall, we do see some differences in the variables. The means of those who survive are more similar to the overall sample mean as those who survive represent more of the sample population.  In terms of difference between means we see that age is slightly higher for those who do not survive, which is logical, as those who are younger will likely be of better overall health and survive a trauma. *Sbp*, *hr*, *log_rr*, *log_cc* and *log_ncell* are all higher for those who do not survive possibly showing that those who have a higher Systolic Blood Pressure, Heart Rate, Respiratory Rate, continue...





\newpage

### Sample covariance


Below are the sample covariance matrices for the general sample, and then for those who do not survive (1) and those who survive (0). The diagonal is are the variances of the variables and other values outside of the diagonals identify the covariances for the corresponding variables on the in the row and column. First, below, is the Sample covariance matrix for the entire data set without controlling for death.
  

```{r, echo=FALSE}
S <- cov(X_quan)

knitr::kable(S,
      caption = "Sample covariance matrix",
      align="c")
```


Second, here, we provide the  Sample covariance matrix for patients who did not survive (*death* = 1).



```{r, echo=FALSE}
S_death <- cov(X_death)

knitr::kable(S_death,
      caption = "Sample covariance matrix: Did not survive",
      align="c")
```


\newpage

The following below is the  Sample covariance matrix for patients who survived (*death* = 0).



```{r, echo=FALSE}
S_life <- cov(X_life)

knitr::kable(S_life,
      caption = "Sample covariance matrix: Survive",
      align="c")
```



We do not see in many of the categories, large ...


Ohter additional measure of dispersion is called the *Generalized variance*, which is defined as the determinant of the sample convariance. In the case of the three previous covaraince table, the generalized variance is given by the following table:


```{r, echo=FALSE}
determ = c(det(S),det(S_death),det(S_life))
gener_var <- data.frame(t(determ))
colnames(gener_var) <- c("All population", "Death", "Survive")


knitr::kable(gener_var,
      caption = "Generalized variance",
      align="c")
```



\newpage

### Sample correlation



Below are the sample correlation matrices and the correlation plots for the general sample, and then for those who do not survive (1) and those who survive (0). The values outside of the diagonals identify the correlations for the corresponding variables on the in the row and column. 

Below is the sample correlation matrix for the entire sample, without considering *death*.




```{r, echo=FALSE}
R <- cor(X_quan)

knitr::kable(R,
      caption = "Sample correlation matrix",
      align="c")
```



Figure \ref{fig:corr}, shown here is the correlation plot for the entire sample. 



```{r corr, fig.cap = "Sample Correlation Crash2 Dataset\\label{fig:corr}", echo=FALSE}
corrplot(R)
```


Reviewing Figure \ref{fig:corr} and the general sample covariance matrix we see that most values are fairly close to zero meaning most variables do not have a linear correlation.This is expected as our scatter plots did not visually reveal any linear relationships. The maximum absolute value we see is the correlation between log_ncell and log_ndaysicu at 0.3113. Other correlation coefficients that exceed the absolute value of 0.1 are log_ndaysicu and log_injurytime, sbp and log_injurytime, log_rr and hr as well as hr and sbp at -0.2225.  According to Ratner (2009), correlation coefficients with values below 0.3 are considered weak or minimal relationships. All of our correlation coefficients are within this category. Log_ncell and log_ndaysicu are the only ones to reach the threshold of a "moderate relationship". The fact that log_ncell and log_ndaysicu have a limited moderate relationship could be possibly be due to that fact those who stay in hospital for longer need more blood and those who have serious injuries need more blood and need to stay in hospital more often. We very small positive correlations between most variables but appears that Blood Pressue (sbp) has minor negative correlations with most variables, particularly with Heart Rate (hr), Central Capillary Refill Time (log_cc) and even more minorly, Number of Blood Cells transfused (log_ncell)  (SPOKEN ABOUT LATER). 


Below is the sample correlation matrix for those who did not survive (*death*=1)


```{r, echo=FALSE}
R_death <- cor(X_death)

knitr::kable(R_death,
      caption = "Sample correlation matrix: Did not survive",
      align="c")
```


The following is the sample correlation matrix for those who survived (*death*=0)


```{r, echo=FALSE}
R_life <- cor(X_life)

knitr::kable(R_life,
      caption = "Sample correlation matrix survival patients",
      align="c")
```

Heatmap \ref{fig:heatmap} ... and Figure \ref{fig:corrgroup}, as provided are correlation plots while controlling for death

```{r heatmap, fig.cap = "Heatmap difference between correlation atrices\\label{fig:heatmap}", echo=FALSE}

R_diff <-  R_life - R_death 
heatmap(R_diff, Colv = NA, Rowv = NA, scale="column", main="Heatmap: Difference of Matrix correlations death and survival")
```


```{r corrgroup, fig.cap = "Sample Correlation for death and survival patients from Crash2 Dataset\\label{fig:corrgroup}", echo=FALSE}
par(mfrow=c(1,2))
corrplot(R_death, title="Did not survive")
corrplot(R_life, title="Survived")
```


We do not see any changes in relationships for those who do not survive and people that do. We do see that some correlations seem to get more minor for those who survive but this is likely due to the larger sample size of those who survive as their variances will be less. Some variances do increase for those who survive such as *log_ndaysicu* and *log_ncell*, almost doubles, and rises to a level of correlation at 0.3493 that is consider moderate (Ratner, 2009). This may be because, for those that do not survive, they receive a lot of blood to attempt to save their lives, but do not survive long enough to stay in the ICU due to the severity of their trauma. This therefore would limit the covariance. For those who survive, they possibly could remain in hospital longer therefore receive more blood over those days, incresing the covariance.



TO INSERT: In conclusion, that since there is not much colinearity in these variables there is good potential for regression, however, the issue is that the two categories for death are not easily seperated, which means the analysis would likely not be accurate. 

### Outliers


INSET SOMEHWERE: We don't use shrinkage analysis because we have many more observations ($n = 9497$) than variables. 


Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.



```{r, echo=FALSE}
MCD_est <- CovMcd(X_quan, alpha=0.75, nsamp="deterministic")
m_MCD <- MCD_est$center

knitr::kable(t(m_MCD),
      row.names = FALSE,
      caption = "Sample robust mean",
      align="c")
```

Comparison of the eigenvalues of the covariance matrix for sample and robust is given by figure \ref{fig:robust} ...

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

```{r robust, fig.cap = "Comparison eigenvalues sample and robust covariance\\label{fig:robust}", echo=FALSE}
S_MCD <- MCD_est$cov
R_MCD <- cov2cor(S_MCD)
eval_S <- eigen(S)$values
eval_S_MCD <- eigen(S_MCD)$values

min_y <- min(cbind(eval_S,eval_S_MCD)) - 1
max_y <- max(cbind(eval_S,eval_S_MCD)) + 1

plot(1:8,
     eval_S,
     col=color_1,
     type="b",
     xlab="Number",
     ylab="Eigenvalues",
     pch=19,
     ylim=c(min_y,max_y),
     main="Comparison of eigenvalues")
points(1:8,
       eval_S_MCD,
       col=color_2,
       type="b",
       pch=19)
legend(5,600,
       legend=c("Eigenvalues of S","Eigenvalues of S MCD"),
       col=c(color_1,color_2),
       lty=1,
       cex=1.2)
```


The eigenvalues are used 



```{r corrout, fig.cap = "Correlation all population and MCD correlation\\label{fig:corrout}", echo=FALSE}
par(mfrow=c(1,2))
corrplot(R)
corrplot(R_MCD)
```


figure \ref{fig:corrout} Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.


\newpage


## Principal Component Analysis

We can divide our quantitative variables in three categories:

1. Individual factors

  i) Age
  ii) injurytime

2. Biometrics

  i) sbp
  ii) rr
  iii) cc
  iv) hr

3. Medical attention

  i) ndaysicu
  ii) ncell


Then, we will discriminate how the principal components uses this variables.

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

## PCA Complete dataset

In figure 25, we plot the first 2 PC. In this case, there is approximately 40% of the variance explained with these two principal components

In green color, there is the survival patients and orange is the death patients. Is is difficult to see a clear sepatations between both populutions. In the same, there is no linear relationship between these two  groups.

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.


![First two PCs based on the sample covariance all population](figure_output/pca_death.png)

On the other hand, we will analize the weights of the fist two principal components. This can be seen in the figure \ref{fig:l1pc}. For the case of the first PC (Left), the largest positive value are associated with the specfic variable of *sbp*. Some studies, for example [Banegas et all](https://pubmed.ncbi.nlm.nih.gov/11896505/) and [Kurl et all](https://www.ahajournals.org/doi/full/10.1161/hs0901.095395) suggest that Systolic blood pressure is a more frequent cardiovascular risk factor than other blood related measures and can be used in order to detect future diseases. So, it appears that this principal components reflects these effect for the patients.

In the case of the second Principal component (Right) the largest positive value with the medical attention and injury time. It suggets that previous you receive medical attention, it is possible that you can have more chance for survival.

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

```{r l1pc, fig.cap = "Loadings for the first and sencond PCs individually\\label{fig:l1pc}", echo=FALSE}
# Categorical variables
Y <- X[,c(1,3,6)]
X <- X_quan
n <- nrow(X)
p <- ncol(X)
X_pcs <- prcomp(X,scale=TRUE)

par(mfrow=c(1,2))
plot(1:p,X_pcs$rotation[,1],pch=19,col=color_1,main="Weights for the first PC",
     xlab="Variables",ylab="Score", xlim = c(1, 9), ylim = c(-1, 1))
abline(h=0)
text(1:p,X_pcs$rotation[,1],labels=colnames(X),pos=1,col=color_4,cex=0.75)
# plot 2
plot(1:p,X_pcs$rotation[,2],pch=19,col=color_1,main="Weights for the second PC",
     xlab="Variables",ylab="Score",xlim = c(1, 9), ylim = c(-1, 1))
abline(h=0)
text(1:p,X_pcs$rotation[,2],labels=colnames(X),pos=1,col=color_4,cex=0.75)
```

On the other hand, when we consider the loadings for the first two PCs (figure \ref{fig:l3pc}) that larges value in magnitude are associated with the sbp pressure and medical attention.

It is important to notice the inverse relation between sbp and other biometric measures. For example

* [Herakova et all](https://clinicalhypertension.biomedcentral.com/articles/10.1186/s40885-017-0071-3) report that  in general deep breathing could reduce blood pressures (BP). So we 

* [Harvard Heart Letter](https://www.health.harvard.edu/heart-health/does-heart-rate-affect-blood-pressure)  reports that an *isolated increase in blood pressure can drop the heart rate a little*

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

```{r l3pc, fig.cap = "Loadings for the first two PC\\label{fig:l3pc}", echo=FALSE}
plot(X_pcs$rotation[,1:2],
     pch=19,
     col=color_1,
     main = "PCA graph of variables \n Weights for the first two PCs",
     xlim = c(-1,1),
     ylim = c(-1,1),
     xlab = "PC1 (19.46%)",
     ylab = "PC2 (17.22%)"
     )
abline(h=0,v=0)
text(X_pcs$rotation[,1:2],labels=colnames(X),pos=1,col=color_4,cex=0.75)
draw.circle(0,0,1,border=color_4,lwd=1)
```


Finally figure 28 reflects the PC scores and PC loadings. In this case, it is difficult to make conclusions due to the numbers of observed individuals, but we can make the following assevarations:

* There is a strong positive relation between age and injury time.

* There is no relation between the ndaysicu with the biometrical measures as sbp and hr. It makes sense, because this is a variable more related with the medical attention, as can be appreciated with the variables *ncell* and *injurytime*

![PC Scores and PC loading all population](figure_output/pca_biplot.png)

The figure \ref{fig:pcaeigv} shows the explained variance of the eigenvalue. We see that the first 4 principal components explains approximately 63% of the model.

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

```{r pcaeigv, fig.cap = "Eigenvalues of the sample correlation matrix\\label{fig:pcaeigv}", echo=FALSE}
fviz_eig(X_pcs,ncp=17,addlabels=T,barfill=color_1,barcolor=`color_4`)
```

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

Figure 30 reflects the relations in the first four principal componets. We do not appreciate a clear distintion bewteen the groups, and the ausence of linear relation between them.

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

![PC Scores and PC loading all population](figure_output/pca_4pc2.png)

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

Finally figure \ref{fig:corrpc} explain the correlation between the variables and the principal components. IN the case of tghe first principal components, in magnitude the biometrical measures and medical attention variables are the more related with them.  In the case of the second principal component, the individual factors such age and injury time adquire more relevance in the analisis.

In case of age this i more influential in PC4, and it can explain the right orange points in figure 35.

```{r corrpc, fig.cap = "Correlation between dataset and all PC\\label{fig:corrpc}", echo=FALSE}
corrplot(cor(X,X_pcs$x),is.corr=T)
#corrplot(cor(X,X_pcs$x[,1:4]),is.corr=T)
```

**IS NECESSARY TO DO THE SAME BY CLASS?**

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.


\newpage

## PCA by Category

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.


Important. For these plot the groups are now female (blue) and male (gray)

![PC Scores and PC loading all population](figure_output/pca_groups.png)

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.


figure \ref{fig:l1pcgrp}...

```{r l1pcgrp, fig.cap = "Loadings for the first two PC by death and survival patients\\label{fig:l1pcgrp}", echo=FALSE}
load('rda/clinical_trial_complete.rda')
X <- clinical_trial_complete[,-c(1,11,13,14,15,16,18)]

## Population: Death
X_death <- X[X$death == 1,]
X_death <- X_death[,-c(3,6,7,9,10)]

Y_death <- X_death[,c(1,3,6)]
X_death <- X_death[,-c(1,3,6)]

n_death <- nrow(X_death)
p_death <- ncol(X_death)

X_pcs_death <- prcomp(X_death,scale=TRUE)


## Survival

X_surv <- X[X$death == 0,]
X_surv <- X_surv[,-c(3,6,7,9,10)]

Y_surv <- X_surv[,c(1,3,6)]
X_surv <- X_surv[,-c(1,3,6)]

n_surv <- nrow(X_surv)
p_surv <- ncol(X_surv)


X_pcs_surv <- prcomp(X_surv,scale=TRUE)


#par(mfrow=c(1,2))
#plot(1:p_death,X_pcs_death$rotation[,1],pch=19,col=color_1,main="Weights for the first PC death patients",
#     xlab="Variables",ylab="Score")
#abline(h=0)
#text(1:p_death,X_pcs_death$rotation[,1],labels=colnames(X_death),pos=1,col=color_4,cex=0.75)

#plot(1:p_surv,X_pcs_surv$rotation[,1],pch=19,col=color_1,main="Weights for the first PC survival patients",
#     xlab="Variables",ylab="Score")
#abline(h=0)
#text(1:p_surv,X_pcs_surv$rotation[,1],labels=colnames(X_surv),pos=1,col=color_4,cex=0.75)

par(mfrow=c(1,2))
plot(X_pcs_death$rotation[,1:2],
     pch=19,
     col=color_1,
     main = "PCA graph of variables (death patients) \n Weights for the first two PCs",
     xlim = c(-1,1),
     ylim = c(-1,1),
     xlab = "PC1 (19.1%)",
     ylab = "PC2 (16.1%)"
)
abline(h=0,v=0)
text(X_pcs_death$rotation[,1:2],labels=colnames(X_death),pos=1,col=color_4,cex=0.75)
draw.circle(0,0,1,border=color_4,lwd=1)
## plot 2
plot(X_pcs_surv$rotation[,1:2],
     pch=19,
     col=color_1,
     main = "PCA graph of variables (survival patients) \n Weights for the first two PCs",
     xlim = c(-1,1),
     ylim = c(-1,1),
     xlab = "PC1 (19.8%)",
     ylab = "PC2 (17.5%)"
)
abline(h=0,v=0)
text(X_pcs_surv$rotation[,1:2],labels=colnames(X_surv),pos=1,col=color_4,cex=0.75)
draw.circle(0,0,1,border=color_4,lwd=1)

```


Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.


Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.


![PC Scores and PC loading all population for death and survival patiens](figure_output/pca_group_biplot)


Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

Figures \ref{fig:pcaeigvgr1} and  \ref{fig:pcaeigvgr2} ... 

```{r pcaeigvgr1, fig.cap = "Eigenvalues of the sample correlation matrix for death patients\\label{fig:pcaeigvgr1}", echo=FALSE}
fviz_eig(X_pcs_death,ncp=8,addlabels=T,barfill=color_1,barcolor=`color_4`)
```


```{r pcaeigvgr2, fig.cap = "Eigenvalues of the sample correlation matrix for survival patients\\label{fig:pcaeigvgr2}", echo=FALSE}
fviz_eig(X_pcs_surv,ncp=8,addlabels=T,barfill=color_1,barcolor=`color_4`)
```

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.


\newpage

## Conclusions

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.


## References

1. Banegas JR, de la Cruz JJ, Rodriguez-Artalejo F, Graciani A, Guallar-Castillon P, Herruzo R. Systolic vs diastolic blood pressure: community burden and impact on blood pressure staging. J Hum Hypertens. 2002 Mar;16(3):163-7. doi: 10.1038/sj.jhh.1001310. PMID: 11896505.

2. S. Kurl, J.A. Laukkanen, R. Rauramaa, T.A. Lakka, J. Sivenius, and J.T. Salonen. Systolic Blood Pressure Response to Exercise Stress Test and Risk of Stroke.  Sep 2001 https://doi.org/10.1161/hs0901.095395Stroke. 2001;32:2036â€“2041

3. Ratner, B. The correlation coefficient: Its values range between $+1/-1$, or do they? J Target Meas Anal Mark 17, $139-142$ (2009). https://doi.org/10.1057/jt.2009.5


